## Переменные окружения\n\n- `BOT_TOKEN` — токен Telegram-бота\n- `ADMIN_CHAT_ID` — ID админского канала/чата\n- `ADMIN_KEY` — админский PIN для смены режима торговли через `/trade mode`\n- `BINANCE_API_KEY` — ключ Binance (пока не используется)\n- `BINANCE_API_SECRET` — секрет Binance (пока не используется)\n- `HTTP_PROXY` — HTTP-прокси (пока не используется)\n- `HTTPS_PROXY` — HTTPS-прокси (пока не используется)\n- `RAW_MAX_BYTES` — лимит размера raw-файлов (пока не используется)\n- `STORAGE_DIR` — корень диска на Render для хранения json/jsonl\n- `WEBHOOK_BASE` — публичный URL сервиса на Render без завершающего `/`\n- `TF1` — старший таймфрейм (например, "12")\n- `TF2` — младший таймфрейм\n- `GRID_DEPTH_UP` — множитель глубины сетки по ATR для режима рынка UP (целое, по умолчанию 2).\n- `GRID_DEPTH_RANGE` — множитель глубины сетки по ATR для режима RANGE (целое, по умолчанию 3).\n- `GRID_DEPTH_DOWN` — множитель глубины сетки по ATR для режима DOWN (целое, по умолчанию 6).\n- `GRID_ANCHOR` — якорь сетки: `MA` (MA по TF1) или `PRICE` (текущая цена). Любое другое значение трактуется как `MA`.\n (например, "6")\n- `MARKET_PUBLISH` — окно (в часах) для агрегации рынка в командах `/market` и `/market force` (по умолчанию 24)\n\n## История версий (кратко)\n\n- **2.8.6** — запрещена команда /symbols xxx, xxxx... при активной кампании \n- **3.9** — добавлен модуль `grid_sim.py` с каркасом `simulate_bar_for_symbol()` (шаг 2.2.1, только проверки и загрузка сетки без изменений).\n- **3.8** — добавлены точки входа SIM/LIVE в /dca start и roll_grid_for_symbol (ветки с TODO, без изменения текущей логики).\n- **3.7** — добавлены хелперы `is_sim_mode()` и `is_live_mode()` и зафиксирована памятка по встраиванию SIM/LIVE в остальные модули.\n- **3.6** — исправлена ошибка UnboundLocalError для `_pending_mode` в обработчике PIN и стабилизировано логирование смены режима торговли.\n- **2.8.5** — запрещено менять DCA-конфиг (on/off, budget, levels) при активной кампании: любые /dca set и /dca on|off требуют сначала остановить кампанию через /dca stop <symbol>\n- **3.3** — исправлен импорт SkipHandler для aiogram, команда `/trade` не ломает запуск бота.\n- **3.2** — доработана обработка PIN для `/trade`: остальные команды не блокируются, если смена режима не запрошена.\n- **3.1** — добавлена команда `/trade mode sim|live` с защитой PIN (ADMIN_KEY).\n- **3.0** — добавлен trade_mode.json (режим торговли sim/live, без команд), подготовка к симуляции.\n- **2.8.4** - добавили команды /dca status all /dca status active\n- **2.8.2** - обнуляем бюджет при остановке компании\n- **2.8.1.** - Добавили логирование /dca stop\n- **2.8** - Ротация сетки. Привязка к Publish и планировщику. Логирование grid_rolled\n- **2.7.2** - Догирование grid_created\n- **2.7.1** - Создание первой сетки\n- **2.5** — добавлены базовые Telegram-команды для управления конфигурацией DCA (`/dca`, `/dca list`, `/dca cfg`, `/dca set`, `/dca on/off`). Логика сеток и ордеров пока не активна.\n- **2.4** — добавлен каркас DCA (модули `dca_models.py`, `dca_config.py`, `dca_storage.py` для хранения конфигураций и состояния сетok) и устранён циклический импорт планировщика через ленивый импорт функций из `metrics`.\n- **2.2** — команды `/scheduler` перенесены в основной модуль команд (metrics), чтобы гарантированно обрабатываться; фоновой планировщик остался в `scheduler.py`.\n- **2.1** — исправлена обработка `/data` без аргументов (больше нет ошибок IndexError), логика 2.0 сохранена.\n- **2.0** — фоновый планировщик (scheduler): шаг 1 — периодический сбор сырья (аналог тихого `/now`), шаг 2 — периодический `/market force` по окну MARKET_PUBLISH с уведомлением админа об изменении режимов рынка; команды `/scheduler` для управления.\n- **1.9** — корректный min_notional в symbol_info из NOTIONAL, float-дубли числовых фильтров в SYMBOLstate.json, команды `/market` и `/market force` работают с окном MARKET_PUBLISH.\n- **1.8** — агрегированный SYMBOLstate.json на основе логов `SYMBOLraw_market.jsonl`, команды `/market` и `/market force`.\n- **1.7** — расширенный `/now`: 100 свечей, расчёт MA/ATR/сигнал/`market_mode`, расширенный `trading_params`, лог `raw_market.jsonl`.\n- **1.6 и ниже** — базовый скелет бота, `/symbols`, `/help`, `/now` с созданием каркаса сырья, `/data` для работы с файлами.\n\n## Памятка SIM/LIVE\n\n- Узел режима торговли: модуль `trade_mode.py`.\n- Основные функции API для остального кода бота:\n  - `get_trade_mode() -> str` — вернуть `"sim"` или `"live"`.\n  - `is_sim_mode() -> bool` — глобальный режим симуляции (без прямого доступа к Binance).\n  - `is_live_mode() -> bool` — боевой режим с реальными ордерами (будет реализован позже).\n- Рекомендации по встраиванию:\n  - В обработчиках `/dca start` и других команд DCA использовать `get_trade_mode()` или `is_sim_mode()/is_live_mode()` для выбора ветки логики.\n  - В функциях перекатки сеток (`roll_grid_for_symbol` и т.п.) заранее закладывать ветки:\n    - `if is_sim_mode():` — обновление файлов и виртуальных ордеров.\n    - `elif is_live_mode():` — реальная работа с ордерами на бирже (после внедрения Binance API).\n  - В логике проверки исполнений (fills) разделять источники данных:\n    - SIM: свечи (`open/high/low/close`) и локальные файлы.\n    - LIVE: статусы ордеров с биржи.