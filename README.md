# Trader Bot — версия 2.8

Телеграм-бот под деплой на Render, работающий через webhook.

## Основные возможности

- Вебхук для Telegram через FastAPI.
- Health-check эндпоинты: `GET /health` и `HEAD /health`.
- Уведомление админа при запуске: сообщение "Бот запущен. Версия 2.8".
- Команда `/start` отвечает: "Бот онлайн. Версия 2.8".

## Команды бота

См. файл `Bot_commands.txt`, команда `/help` отправляет его содержимое в чат.

Кратко:

- `/symbols` — управление списком торговых пар (хранится в `STORAGE_DIR/symbols_list.json`).
- `/now` — сбор и пересчёт сырых данных по символам:
  - тянет с Binance до 100 свечей по `TF1` и `TF2`,
  - записывает в `<SYMBOL>.json`:
    - свечи по каждому TF (до 100 штук),
    - массивы `ma30_arr`, `ma90_arr`, `atr14_arr`,
    - сигналы по каждому TF (`UP/DOWN/RANGE`),
    - агрегированный `market_mode`,
    - блок `trading_params`:
      - текущие цены (`last`, `bid`, `ask`),
      - `symbol_info` с `tick_size`, `step_size`, `min_qty`, `min_notional`, базовой и котируемой валютой,
      - сырые `filters` из `exchangeInfo`,
      - комиссии `fees` (пока статичные).
  - в файл `<SYMBOL>raw_market.jsonl` построчно складывает снэпшоты:
    - `ts`, `symbol`, `market_mode`, `tf1`, `tf2`, `signal_tf1`, `signal_tf2`.
- `/data` — работа с файлами в `STORAGE_DIR`:
  - список файлов, экспорт, удаление, импорт по caption `/data import`.

## Переменные окружения

- `BOT_TOKEN` — токен Telegram-бота
- `ADMIN_CHAT_ID` — ID админского канала/чата
- `ADMIN_KEY` — ключ админа (зарезервировано)
- `BINANCE_API_KEY` — ключ Binance (пока не используется)
- `BINANCE_API_SECRET` — секрет Binance (пока не используется)
- `HTTP_PROXY` — HTTP-прокси (пока не используется)
- `HTTPS_PROXY` — HTTPS-прокси (пока не используется)
- `RAW_MAX_BYTES` — лимит размера raw-файлов (пока не используется)
- `STORAGE_DIR` — корень диска на Render для хранения json/jsonl
- `WEBHOOK_BASE` — публичный URL сервиса на Render без завершающего `/`
- `TF1` — старший таймфрейм (например, "12")
- `TF2` — младший таймфрейм
- `GRID_DEPTH_UP` — множитель глубины сетки по ATR для режима рынка UP (целое, по умолчанию 2).
- `GRID_DEPTH_RANGE` — множитель глубины сетки по ATR для режима RANGE (целое, по умолчанию 3).
- `GRID_DEPTH_DOWN` — множитель глубины сетки по ATR для режима DOWN (целое, по умолчанию 6).
- `GRID_ANCHOR` — якорь сетки: `MA` (MA по TF1) или `PRICE` (текущая цена). Любое другое значение трактуется как `MA`.
 (например, "6")
- `MARKET_PUBLISH` — окно (в часах) для агрегации рынка в командах `/market` и `/market force` (по умолчанию 24)

## История версий (кратко)

- **2.8.4** - добавили команды /dca status all /dca status active
- **2.8.2** - обнуляем бюджет при остановке компании
- **2.8.1.** - Добавили логирование /dca stop
- **2.8** - Ротация сетки. Привязка к Publish и планировщику. Логирование grid_rolled
- **2.7.2** - Догирование grid_created
- **2.7.1** - Создание первой сетки
- **2.5** — добавлены базовые Telegram-команды для управления конфигурацией DCA (`/dca`, `/dca list`, `/dca cfg`, `/dca set`, `/dca on/off`). Логика сеток и ордеров пока не активна.
- **2.4** — добавлен каркас DCA (модули `dca_models.py`, `dca_config.py`, `dca_storage.py` для хранения конфигураций и состояния сетok) и устранён циклический импорт планировщика через ленивый импорт функций из `metrics`.
- **2.2** — команды `/scheduler` перенесены в основной модуль команд (metrics), чтобы гарантированно обрабатываться; фоновой планировщик остался в `scheduler.py`.
- **2.1** — исправлена обработка `/data` без аргументов (больше нет ошибок IndexError), логика 2.0 сохранена.
- **2.0** — фоновый планировщик (scheduler): шаг 1 — периодический сбор сырья (аналог тихого `/now`), шаг 2 — периодический `/market force` по окну MARKET_PUBLISH с уведомлением админа об изменении режимов рынка; команды `/scheduler` для управления.
- **1.9** — корректный min_notional в symbol_info из NOTIONAL, float-дубли числовых фильтров в SYMBOLstate.json, команды `/market` и `/market force` работают с окном MARKET_PUBLISH.
- **1.8** — агрегированный SYMBOLstate.json на основе логов `SYMBOLraw_market.jsonl`, команды `/market` и `/market force`.
- **1.7** — расширенный `/now`: 100 свечей, расчёт MA/ATR/сигнал/`market_mode`, расширенный `trading_params`, лог `raw_market.jsonl`.
- **1.6 и ниже** — базовый скелет бота, `/symbols`, `/help`, `/now` с созданием каркаса сырья, `/data` для работы с файлами.
